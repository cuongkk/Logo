<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" />
    <title></title>
    <style>
      --root {
        --font-size: 16px;
      }
      @font-face {
        font-family: "UTM Alberta Heavy";
        src: url("assets/fonts/UTM-Alberta-Heavy.ttf") format("truetype");
        font-weight: 700;
        font-style: normal;
      }

      @font-face {
        font-family: "UTM Facebook KT Italic";
        src: url("assets/fonts/UTMFacebookK&TItalic.ttf") format("truetype");
        font-weight: 700;
        font-style: normal;
      }

      .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        object-fit: cover;
      }
      .container {
        margin: 30px 60px;
        font-family: Arial, sans-serif;
      }
      .inner-head {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 16px;
        gap: 180px;
      }
      .inner-title {
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        font-weight: 700;
        font-size: 25px;
        color: #2a47d4;
      }
      .inner-content {
        display: flex;
        justify-content: center;
        align-self: flex-start;
        flex-direction: row;
        gap: 24px;
      }
      .inner-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 10px;
      }
      .inner-label {
        display: inline-block;
        margin-bottom: 4px;
        font-size: 14px;
        font-weight: 400;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #438ec4;
        color: #ffffff;
      }
      textarea {
        width: 300px;
        min-height: 40px;
        padding: 5px;
        box-sizing: border-box;
        resize: none;
        border: 2px solid #438ec4;
        border-radius: 5px;
        font-family: "UTM Facebook KT Italic", sans-serif;
      }
      textarea::placeholder {
        font-size: 14px;
        color: #999;
      }
      #input-name {
        height: 40px;
      }
      #input-position {
        height: 80px;
      }
      #input-message {
        height: 120px;
      }
      .card-template {
        position: relative;
        aspect-ratio: 1920/1080;
        height: 768px;
        background-size: contain;
      }
      .card-template .background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .photo-slot {
        position: absolute;
        top: calc(378 / 1080 * 100%);
        left: calc(178 / 1920 * 100%);
        width: calc(404 / 1920 * 100%);
        height: calc(404 / 1080 * 100%);
        overflow: hidden;
        border-radius: 50%;
      }
      .photo-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
      }
      .message-slot {
        position: absolute;
        top: calc(468 / 1080 * 100%);
        left: calc(760 / 1920 * 100%);
        width: calc(988 / 1920 * 100%);
        max-height: calc(360 / 1080 * 100%);
        text-align: justify;
        display: inline-block;
        font-size: 16px;
        font-weight: 400;
        text-align: left;
        font-family: "UTM Facebook KT Italic", sans-serif;
        color: #0000ff;
        overflow: hidden;
      }

      .message-slot .preview-message {
        width: calc(100%-80px);
        flex-wrap: wrap;
      }

      .name-slot {
        position: absolute;
        top: calc(810 / 1080 * 100%);
        left: calc(150 / 1920 * 100%);
        width: calc(450 / 1920 * 100%);
        max-height: calc(40 / 1080 * 100%);
        text-align: center;
        font-size: 16px;
        font-weight: 400;
        text-align: center;
        font-family: Albert;
        font-family: "UTM Alberta Heavy", sans-serif;
        color: #fff;
        overflow: hidden;
      }
      .position-slot {
        position: absolute;
        top: calc(900 / 1080 * 100%);
        left: calc(140 / 1920 * 100%);
        width: calc(450 / 1920 * 100%);
        max-height: calc(80 / 1080 * 100%);
        text-align: center;
        font-size: 16px;
        font-weight: 400;
        text-align: center;
        font-family: "UTM Facebook KT Italic", sans-serif;
        color: #221a9d;
        overflow: hidden;
      }

      #preview-img[src=""] {
        display: none;
      }
      #preview-message,
      #preview-position {
        font-family: "UTM Facebook KT Italic", sans-serif;
      }

      #preview-name {
        font-family: "UTM Alberta Heavy", sans-serif;
      }
      #preview-message,
      #preview-name,
      #preview-position {
        width: 100%;
        font-size: var(--font-size);
        line-height: 1.2;

        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-break: break-word;
      }

      .btn-download {
        margin-top: 16px;
        padding: 8px 16px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }
      #input-image {
        display: none;
      }

      .btn-choose-file {
        padding: 5px;
        border-radius: 4px;
        border: none;
        background-color: #438ec4;
        color: #fff;
        cursor: pointer;
        font-weight: 400;
        display: inline-block;
      }
      .btn-choose-file:hover {
        opacity: 0.9;
      }
      .btn-download {
        background-color: #438ec4;
        color: white;
        font-weight: 600;
      }
      .btn-download:hover {
        background-color: #438ec4;
      }
      .plate {
        width: calc(224 / 1920 * 100%);
        height: calc(51 / 1080 * 100%);
        background: #108fcf;

        clip-path: polygon(7% 0, /* góc trên trái lùi vào */ 100% 0, /* góc trên phải */ 93% 100%, /* góc dưới phải lùi vào */ 0 100% /* góc dưới trái */);

        position: absolute;
        top: calc(756 / 1080 * 100%);
        left: calc(192 / 1920 * 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 600;
        z-index: 1;
      }
      @media (max-width: 1699.99px) {
        .container {
          margin: 20px;
        }
        .inner-head {
          gap: 100px;
        }
        .inner-content {
          flex-direction: column;
          align-items: center;
        }
      }

      @media (max-width: 1399.99px) {
        .card-template {
          height: 600px;
        }
        :root {
          --font-size: 15px;
        }
      }
      @media (max-width: 1099.99px) {
        .card-template {
          height: 500px;
        }
        .inner-title {
          font-size: 20px;
        }
        :root {
          --font-size: 14px;
        }
      }
      @media (max-width: 899.99px) {
        .card-template {
          height: 400px;
        }
        .inner-title {
          font-size: 16px;
        }
        :root {
          --font-size: 12px;
        }
      }

      @media (max-width: 739.99px) {
        .card-template {
          height: 300px;
        }
        .inner-title {
          display: none;
        }
        :root {
          --font-size: 10px;
        }
      }
      @media (max-width: 576.99px) {
        .card-template {
          height: 250px;
        }
        :root {
          --font-size: 9px;
        }
      }

      @media (max-width: 467.99px) {
        .card-template {
          height: 200px;
        }
        :root {
          --font-size: 7px;
        }
        #preview-position {
          font-size: 6px;
        }
      }
      @media (max-width: 367.99px) {
        .card-template {
          height: 180px;
        }
        :root {
          --font-size: 6px;
        }
        #preview-position {
          font-size: 4px;
        }
      }
      .crop-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* ẩn mặc định */
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .crop-modal-content {
        background: #fff;
        padding: 16px;
        border-radius: 8px;
        max-width: 80vw;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .crop-modal-body {
        flex: 1;
        min-width: 300px;
        min-height: 300px;
        max-width: 70vw;
        max-height: 60vh;
        overflow: hidden;
      }

      #crop-image {
        max-width: 100%;
        max-height: 100%;
        display: block;
      }

      .crop-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .crop-modal-actions button {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <img class="background" src="assets/image/Background.jpg" alt="background" />
    <div class="container">
      <div class="inner-head">
        <div class="inner-logo">
          <img src="assets/image/Logo.png" alt="logo" width="100" />
        </div>
        <div class="inner-title">
          <span>ĐẠI HỘI ĐẠI BIỂU ĐOÀN TNCS HỒ CHÍ MINH TỈNH GIA LAI</span>
          <span>LẦN THỨ I, NHIỆM KỲ 2025-2030</span>
        </div>
      </div>
      <div class="inner-content">
        <div class="inner-infor">
          <div class="inner-group">
            <label for="input-image" class="btn-choose-file">Chọn ảnh</label>
            <input type="file" id="input-image" accept="image/*" />
          </div>

          <div class="inner-group">
            <div class="inner-label">Họ tên</div>
            <textarea id="input-name" type="text" placeholder="Họ và tên.."></textarea>
          </div>
          <div class="inner-group">
            <div class="inner-label">Chức vụ</div>
            <textarea id="input-position" type="text" placeholder="Chức vụ.."></textarea>
          </div>
          <div class="inner-group">
            <div class="inner-label">Gửi lời nhắn đến đại hội</div>
            <textarea id="input-message" type="text" placeholder="Lời nhắn .."></textarea>
          </div>
          <div class="inner-group">
            <button class="btn-download" id="btn-download">Tải lời nhắn về</button>
          </div>
        </div>
        <div class="image">
          <div id="card-preview" class="card-template">
            <img class="background" src="assets/image/Nen.png" />
            <div class="plate"></div>
            <div class="photo-slot">
              <img id="preview-img" src="" />
            </div>
            <div class="message-slot">
              <div id="preview-message"></div>
            </div>
            <div class="name-slot">
              <div id="preview-name"></div>
            </div>
            <div class="position-slot">
              <div id="preview-position"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="crop-modal" id="crop-modal">
        <div class="crop-modal-content">
          <div class="crop-modal-body">
            <img id="crop-image" src="" />
          </div>
          <div class="crop-modal-actions">
            <button id="crop-confirm">Dùng ảnh này</button>
            <button id="crop-cancel">Hủy</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      // Lấy các phần tử input + preview
      const inputImage = document.getElementById("input-image");
      const inputName = document.getElementById("input-name");
      const inputPosition = document.getElementById("input-position");
      const inputMessage = document.getElementById("input-message");

      const previewImg = document.getElementById("preview-img");
      const previewName = document.getElementById("preview-name");
      const previewPosition = document.getElementById("preview-position");
      const previewMessage = document.getElementById("preview-message");

      const btnDownload = document.getElementById("btn-download");
      const cardPreview = document.getElementById("card-preview");

      // Khi chọn ảnh
      inputImage.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          previewImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Khi nhập Họ tên
      inputName.addEventListener("input", function () {
        previewName.textContent = this.value;
      });

      // Khi nhập Chức vụ
      inputPosition.addEventListener("input", function () {
        previewPosition.textContent = this.value;
      });

      // Khi nhập Lời nhắn
      inputMessage.addEventListener("input", function () {
        previewMessage.textContent = this.value;
      });

      let designHeight = null;

      const bgImg = new Image();
      bgImg.src = "assets/image/nen.png";
      bgImg.onload = function () {
        designHeight = bgImg.naturalHeight;
      };

      btnDownload.addEventListener("click", function () {
        if (!cardPreview) {
          console.error("Không tìm thấy #card-preview");
          return;
        }

        const rect = cardPreview.getBoundingClientRect();
        const currentHeight = rect.height;

        let scale = 2;
        if (designHeight && currentHeight) {
          scale = designHeight / currentHeight;
        }

        console.log("currentHeight =", currentHeight, "scale =", scale);

        html2canvas(cardPreview, {
          scale: scale,
          useCORS: true,
          backgroundColor: null,
        }).then((canvas) => {
          const link = document.createElement("a");
          link.download = "the-dai-bieu.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
        });
      });

      const cropModal = document.getElementById("crop-modal");
      const cropImage = document.getElementById("crop-image");
      const cropConfirm = document.getElementById("crop-confirm");
      const cropCancel = document.getElementById("crop-cancel");

      let cropper = null;

      // 1. Chọn file → mở popup crop
      inputImage.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          cropImage.src = e.target.result;

          // Hiện popup
          cropModal.style.display = "flex";

          // Đợi ảnh load xong rồi mới init cropper
          cropImage.onload = function () {
            if (cropper) {
              cropper.destroy();
            }
            cropper = new Cropper(cropImage, {
              aspectRatio: 4 / 5, // tỉ lệ khung ảnh, chỉnh theo .photo-slot
              viewMode: 1,
              movable: true,
              zoomable: true,
              responsive: true,
              background: false,
            });
          };
        };
        reader.readAsDataURL(file);
      });

      // 2. Bấm "Dùng ảnh này" → lấy ảnh đã cắt, gán vào preview-img
      cropConfirm.addEventListener("click", function () {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({
          width: 400, // size ảnh xuất ra, bạn chỉnh được
          height: 500,
        });

        previewImg.src = canvas.toDataURL("image/png");

        // đóng popup + giải phóng cropper
        cropper.destroy();
        cropper = null;
        cropModal.style.display = "none";
      });

      // 3. Hủy: đóng popup + bỏ cropper (không thay đổi preview-img)
      cropCancel.addEventListener("click", function () {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        cropModal.style.display = "none";
      });
    </script>
  </body>
</html>
